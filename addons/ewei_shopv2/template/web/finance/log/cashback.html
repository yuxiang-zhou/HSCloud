{template '_header'}
<div class="page-heading"> <h2>销售返现</h2> </div>
<form action="./index.php" method="get" class="form-horizontal" role="form" id="form1">
    <input type="hidden" name="c" value="site" />
    <input type="hidden" name="a" value="entry" />
    <input type="hidden" name="m" value="ewei_shopv2" />
    <input type="hidden" name="do" value="web" />
    <input type="hidden" name="r" value="finance.log.cashback" />
    <div class="page-toolbar row m-b-sm m-t-sm">


        <div class="col-sm-4" style='padding-right:0;'>

            <div class="btn-group btn-group-sm" style='float:left'>
                <button class="btn btn-default btn-sm"  type="button" data-toggle='refresh'><i class='fa fa-refresh'></i></button>

            </div>
            <select name='status' class='form-control  input-sm'   style="width:240px;"  >
                <option value='' {if $_GPC['status']==''}selected{/if}>状态</option>
                <option value='1' {if $_GPC['status']=='1'}selected{/if}>已返现</option>
                <option value='0' {if $_GPC['status']=='0'}selected{/if}>未返现</option>

            </select>
        </div>

        <div class="col-sm-8 pull-right" style='text-align: right'>

            <select name='groupid' class='form-control  input-sm select-md' style="width:140px;float: right;"  >
                <option value=''>会员分组</option>
                {loop $groups $group}
                <option value='{$group['id']}' {if $_GPC['groupid']==$group['id']}selected{/if}>{$group['groupname']}</option>
                {/loop}
            </select>
            <select name='level' class='form-control  input-sm select-md' style="width:140px;float: right;"  >
                <option value=''>会员等级</option>
                {loop $levels $level}
                <option value='{$level['id']}' {if $_GPC['level']==$level['id']}selected{/if}>{$level['levelname']}</option>
                {/loop}
            </select>

        </div>
    </div>

    <div class="page-toolbar row"
         id='moresearch' >
        <div class='col-sm-4' style='padding-right:0'>
            {php echo tpl_daterange('time', array('sm'=>true,'placeholder'=>'返现时间'),true);}
        </div>

        <div class="col-sm-8 pull-right">

            <select name='searchfield'  class='form-control  input-sm select-md'   style="width:110px;"  >

                <option value='logno' {if $_GPC['searchfield']=='logno'}selected{/if}>订单号</option>
                <option value='member' {if $_GPC['searchfield']=='member'}selected{/if}>会员信息</option>

            </select>
            <div class="input-group " >
                <input type="text" class="form-control input-sm"  name="keyword" value="{$_GPC['keyword']}" placeholder="请输入关键词" />
                <span class="input-group-btn">
                <button class="btn btn-sm btn-primary" type="submit"> 搜索</button>
                {ifp 'finance.log.recharge.export'}
                	<button type="submit" name="export" value="1" class="btn btn-success btn-sm">导出 Excel</button>
                {/if}
            </span>
            </div>

        </div>

    </div>
</form>

<table class="table table-hover table-responsive">
    <thead class="navbar-inner">
    <tr>

        <th style='width:160px;'>订单号</th>
        <th style='width:120px;'>粉丝</th>
        <th style='width:100px;'>会员信息</th>

        <th style='width:100px;'>已返现金额</th>
        <th style='width:100px;'>最近返现时间</th>
        <th style='width:80px;'>商品编号</th>
        <th style='width:80px;'>商品价格</th>
        <th style='width:80px;'>购买数量</th>
        <th style='width:80px;'>返现比例</th>
        <th style='width:100px;'>状态</th>
        <th style='width:120px;'>操作</th>
    </tr>
    </thead>
    <tbody>
    {loop $list $row}
    <tr>
        <!-- 订单号 -->
        <td>{$row['ordersn']}</td>
        <!-- 粉丝 -->
        <td data-toggle='tooltip' title='{$row['nickname']}'>
        {ifp 'member.list.detail'}
	        <a  href="{php echo webUrl('member/list/detail',array('id' => $row['mid']));}" target='_blank'>
	            <img src='{$row['avatar']}' style='width:30px;height:30px;padding1px;border:1px solid #ccc' /> {$row['nickname']}
	        </a>
        {else}
        	<img src='{$row['avatar']}' style='width:30px;height:30px;padding1px;border:1px solid #ccc' /> {$row['nickname']}
        {/if}

        </td>
        <!-- 会员信息 -->
        <td>{$row['realname']}<br/>{$row['mobile']}</td>
        <!-- 已返现金额 -->
        <td>{$row['money']}</td>
        <!-- 最近返现时间 -->
        <td>{php echo date('Y-m-d',$row['createtime'])}<br/>{php echo date('H:i',$row['createtime'])}</td>

        <!-- 商品编号 -->
        <td>{$row['goodssn']}</td>
        <!-- 商品价格 -->
        <td>{$row['price']}</td>
        <!-- 购买数量 -->
        <td>{$row['total']}</td>
        <!-- 返现比例 -->
        <td>{php echo number_format(100.0*$row['single_refund_price']*$row['num_refund'] / $row['price'],2)}%</td>

        <!-- status and actions -->
        <td>
            <span class='label label-default'>已返现: {$row['num_refunded']} / {$row['num_refund']}</span>
        </td>


        <td>
            <a class='btn btn-sm btn-danger' data-toggle='ajaxPost' data-confirm="'确认返现{php echo $row['single_refund_price'] * $row['total']}?'" href="{php echo webUrl('finance/log/cashback_fn', $row);}">返现</a>
            
            {if count($row['hist']) > 0}
              <a class='btn btn-sm btn-info' data-toggle="collapse" data-target="#{$row['unique_id']}" aria-expanded="false" aria-controls="{$row['unique_id']}">详情</a>
            {/if}
        </td>

    </tr>

    <tr><td colspan='13' style="padding: 0px"><div class="collapse" id="{$row['unique_id']}">
      {if count($row['hist']) > 0}
      <div class="panel panel-default">
        <div class="panel-heading">详情</div>
        <div class="panel-body ">
          <table class="table table-hover">
            <thead class="navbar-inner">
              <tr>
                <th style='width:120px;'>返现ID</th>
                <th style='width:120px;'>返现规则ID</th>
                <th style='width:120px;'>返现商品</th>
                <th style='width:120px;'>订单号</th>
                <th style='width:120px;'>返现金额</th>
                <th style='width:120px;'>返现时间</th>
              </tr>
            </thead>
            <tbody>
              {loop $row['hist'] $item}
              <tr>
                <td>{$item['id']}</td>
                <td>{$item['refund_id']}</td>
                <td>{$item['goodssn']}</td>
                <td>{$item['ordersn']}</td>
                <td>{$item['price']}</td>
                <td>{php echo date('Y-m-d H:i',$item['time_refund'])}</td>
              </tr>
              {/loop}
            </tbody>
          </table>
        </div>
      </div>
      {/if}
    </div></td></tr>

    {if !empty($row['remark'])}
    <tr style=";border-bottom:none;background:#f9f9f9;">
        <td colspan='8' style='text-align:left'>
            备注:<span class="text-info">{$row['remark']}</span>
        </td>
    </tr>
    {/if}

    {/loop}
    </tbody>
</table>
{$pager}


{template '_footer'}
