{template 'web/_header'}
{template 'web/finance/tabs'}

<div class="panel panel-info">
    <div class="panel-heading">筛选</div>
    <div class="panel-body">
        <form action="./index.php" method="get" class="form-horizontal" role="form" id="form1">
            <input type="hidden" name="c" value="site" />
            <input type="hidden" name="a" value="entry" />
            <input type="hidden" name="m" value="ewei_shop" />
            <input type="hidden" name="do" value="finance" />
            <input type="hidden" name="p" value="log" />
            <input type="hidden" name="type" value="{$_GPC['type']}" />
            <div class="form-group">
                <label class="col-xs-12 col-sm-2 col-md-2 col-lg-1 control-label">会员信息</label>
                <div class="col-sm-8 col-lg-9 col-xs-12">
                    <input type="text" class="form-control"  name="realname" value="{$_GPC['realname']}" placeholder='可搜索会员昵称/姓名/手机号'/>
                </div>
            </div>

             <div class="form-group">
                <label class="col-xs-12 col-sm-2 col-md-2 col-lg-1 control-label">充值单号</label>
                <div class="col-sm-8 col-lg-9 col-xs-12">
                    <input type="text" class="form-control"  name="logno" value="{$_GPC['logno']}" placeholder='可搜索充值单号'/>
                </div>
            </div>

             <div class="form-group">
                <label class="col-xs-12 col-sm-2 col-md-2 col-lg-1 control-label">会员等级</label>
                <div class="col-sm-8 col-lg-9 col-xs-12">
                       <select name='level' class='form-control'>
                        <option value=''></option>
                        {loop $levels $level}
                        <option value='{$level['id']}' {if $_GPC['level']==$level['id']}selected{/if}>{$level['levelname']}</option>
                        {/loop}
                    </select>
                </div>
            </div>
             <div class="form-group">
                <label class="col-xs-12 col-sm-2 col-md-2 col-lg-1 control-label">会员分组</label>
                <div class="col-sm-8 col-lg-9 col-xs-12">
                       <select name='groupid' class='form-control'>
                        <option value=''></option>
                        {loop $groups $group}
                        <option value='{$group['id']}' {if $_GPC['groupid']==$level['id']}selected{/if}>{$group['groupname']}</option>
                        {/loop}
                    </select>
                </div>

            </div>
                <div class="form-group">
                    <label class="col-xs-12 col-sm-2 col-md-2 col-lg-1 control-label">
                        {if $_GPC['type']==1}
                          提现时间
                        {elseif $_GPC['type'] == 0}#
                          充值时间
                        {elseif $_GPC['type'] == 2}
                          返现时间
                        {else}
                          未定义
                        {/if}
                    </label>
                      <div class="col-sm-2">
                            <label class='radio-inline'>
                                <input type='radio' value='0' name='searchtime' {if $_GPC['searchtime']=='0'}checked{/if}>不搜索
                            </label>
                             <label class='radio-inline'>
                                <input type='radio' value='1' name='searchtime' {if $_GPC['searchtime']=='1'}checked{/if}>搜索
                            </label>
                     </div>
                    <div class="col-sm-7 col-lg-9 col-xs-12">
                        {php echo tpl_form_field_daterange('time', array('starttime'=>date('Y-m-d H:i', $starttime),'endtime'=>date('Y-m-d  H:i', $endtime)),true);}
                    </div>

                </div>
            {if $_GPC['type']==0}
               <div class="form-group">
                <label class="col-xs-12 col-sm-2 col-md-2 col-lg-1 control-label">充值方式</label>
                <div class="col-sm-8 col-lg-9 col-xs-12">
                       <select name='rechargetype' class='form-control'>
                         <option value='' {if $_GPC['rechargetype']==''}selected{/if}></option>
                         <option value='wechat' {if $_GPC['rechargetype']=='wechat'}selected{/if}>微信</option>
                         <option value='alipay' {if $_GPC['rechargetype']=='alipay'}selected{/if}>支付宝</option>
                         <option value='system' {if $_GPC['rechargetype']=='system'}selected{/if}>后台</option>
                         <option value='system1' {if $_GPC['rechargetype']=='system1'}selected{/if}>后台扣款</option>
                    </select>
                </div>
               </div>
            {/if}
                 <div class="form-group">
                <label class="col-xs-12 col-sm-2 col-md-2 col-lg-1 control-label">状态</label>
                <div class="col-sm-8 col-lg-9 col-xs-12">
                       <select name='status' class='form-control'>
                         <option value='' {if $_GPC['status']==''}selected{/if}></option>
                         {if $_GPC['type']==0}
                           <option value='1' {if $_GPC['status']=='1'}selected{/if}>充值成功</option>
                           <option value='0' {if $_GPC['status']=='0'}selected{/if}>未充值</option>
                         {/if}
                         {if $_GPC['type']==1}
                           <option value='1' {if $_GPC['status']=='1'}selected{/if}>完成</option>
                           <option value='0' {if $_GPC['status']=='0'}selected{/if}>申请中</option>
                           <option value='-1' {if $_GPC['status']=='-1'}selected{/if}>失败</option>
                         {/if}
                         {if $_GPC['type']==2}
                           <option value='1' {if $_GPC['status']=='1'}selected{/if}>已返现</option>
                           <option value='0' {if $_GPC['status']=='0'}selected{/if}>未返现</option>
                         {/if}

                    </select>
                </div>
               </div>
              <div class="form-group">
                    <label class="col-xs-12 col-sm-2 col-md-2 col-lg-1 control-label"></label>
                    <div class="col-sm-7 col-lg-9 col-xs-12">
                       <button class="btn btn-default"><i class="fa fa-search"></i> 搜索</button>
                         <input type="hidden" name="token" value="{$_W['token']}" />
                          {ifp 'finance.recharge.export|finance.withdraw.export'}
                        <button type="submit" name="export" value="1" class="btn btn-primary">导出 Excel</button>
                        {/if}
                    </div>
                </div>
            <div class="form-group">
            </div>
        </form>
    </div>
</div>
{if $_GPC['type']==2}
  <div class="panel panel-info">
    <div class="panel-heading">返现配置管理 <button type="button" class='btn btn-info btn-sm pull-right' data-toggle="modal" data-target="#myModal">添加</button></div>
    <div class="panel-body">
      <form action="./index.php" method="get" class="form-horizontal" role="form" id="form1">
        <input type="hidden" name="c" value="site" />
        <input type="hidden" name="a" value="entry" />
        <input type="hidden" name="m" value="ewei_shop" />
        <input type="hidden" name="do" value="finance" />
        <input type="hidden" name="p" value="log" />
        <input type="hidden" name="type" value="{$_GPC['type']}" />

        <!-- Modal -->
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
          <div class="modal-dialog" role="document">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">返现配置</h4>
              </div>
              <div class="modal-body">
                <input type="hidden" name="refund_id" value="" />
                <input type="hidden" name="op" value="refund" />
                <input type="hidden" name="action" value="upsert" />
                <div class="form-group">
                  <label class="col-md-4 col-xs-12 control-label">返现商品</label>
                  <div class="col-md-8 col-xs-12">
                      <input type="text" class="form-control" id="update_goodssn" name="update_goodssn" value="" placeholder='商品编号'/>
                  </div>
                </div>
                <div class="form-group">
                  <label class="col-md-4 col-xs-12 control-label">返现周期（月）</label>
                  <div class="col-md-8 col-xs-12">
                      <input type="text" class="form-control"  name="update_period" value="" placeholder='返现周期（月）'/>
                  </div>
                </div>
                <div class="form-group">
                  <label class="col-md-4 col-xs-12 control-label">单笔返现金额</label>
                  <div class="col-md-8 col-xs-12">
                      <input type="text" class="form-control"  name="update_single_refund_price" value="" placeholder='单笔返现金额'/>
                  </div>
                </div>
                <div class="form-group">
                  <label class="col-md-4 col-xs-12 control-label">总返现次数</label>
                  <div class="col-md-8 col-xs-12">
                      <input type="text" class="form-control"  name="update_num_refund" value="" placeholder='总返现次数'/>
                  </div>
                </div>
                <div class="form-group">
                  <label class="col-md-4 col-xs-12 control-label">启用</label>
                  <div class="col-md-8 col-xs-12">
                      <input type="text" class="form-control"  name="update_activate" value="" placeholder='0 or 1'/>
                  </div>
                </div>
                <div class="form-group">
                  <label class="col-md-4 col-xs-12 control-label">起止日期</label>
                  <div class="col-md-8 col-xs-12" id="model_date">
                    {php echo tpl_form_field_daterange('update_time', array('starttime'=>date('Y-m-d H:i', $starttime),'endtime'=>date('Y-m-d  H:i', $endtime)),true);}
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                <button class="btn btn-primary">确认</button>
              </div>
            </div>
          </div>
        </div>

      </form>
      <table class="table table-hover">
          <thead class="navbar-inner">
            <tr>
              <th style='width:120px;'>返现商品</th>
              <th style='width:120px;'>返现周期（月）</th>
              <th style='width:120px;'>单笔返现金额</th>
              <th style='width:120px;'>总返现次数</th>
              <th style='width:120px;'>启用</th>
              <th style='width:120px;'>开始日期</th>
              <th style='width:120px;'>结束日期</th>
              <th style='width:120px;'>操作</th>
            </tr>
          </thead>
          <tbody>
            {loop $refundlist $item}
            <tr>
              <td>{$item['goodssn']}</td>
              <td>{$item['period']}</td>
              <td>{$item['single_refund_price']}</td>
              <td>{$item['num_refund']}</td>
              <td>{if $item['activate']}Yes{else}no{/if}</td>
              <td>{php echo date('Y-m-d H:i',$item['start_date'])}</td>
              <td>
                {if $item['end_date']}
                  {php echo date('Y-m-d H:i',$item['end_date'])}
                {/if}
              </td>
              <td>
                <button type="button" class='btn btn-warning' data-toggle="modal" data-target="#myModal" data-refundid="{$item['id']}" data-goodssn="{$item['goodssn']}" data-period="{$item['period']}" data-srp="{$item['single_refund_price']}" data-nf="{$item['num_refund']}" data-activate="{$item['activate']}" data-startdate="{$item['start_date']}" data-enddate="{$item['end_date']}">更改</button>
                <a class='btn btn-danger' onclick="return confirm('确认删除?')" href="{php echo $this->createWebUrl('finance/log',array_merge(array('op'=>'refund','action'=>'delete','id' => $row['id']),$item));}">删除</a>
              </td>
            </tr>
            {/loop}
          </tbody>
        </table>
    </div>
  </div>
{/if}
<div class="panel panel-default">
    <div class="panel-heading">总数：{$total}</div>
    <div class="panel-body ">
        <table class="table table-hover">
            <thead class="navbar-inner">
                <tr>

                    <!-- general columns -->
                    <th style='width:220px;'>
                      {if $_GPC['type']==0}
                        充值单号
                      {elseif $_GPC['type']==1}
                        提现单号
                      {elseif $_GPC['type']==2}
                        订单号
                      {else}
                        未定义单号
                      {/if}
                    </th>

                    <th style='width:120px;'>粉丝</th>
                    <th style='width:120px;'>会员信息</th>
                    <th style='width:120px;'  class='hidden-xs'>微信号</th>
                    <th style='width:120px;' class='hidden-xs'>会员等级</th>
                    <th style='width:120px;'  class='hidden-xs'>会员分组</th>
                    <th style='width:100px;'>
                      {if $_GPC['type']==1}
                        提现金额
                      {elseif $_GPC['type']==0}
                        充值金额
                      {elseif $_GPC['type']==2}
                        已返现总金额
                      {else}
                        未定义金额
                      {/if}
                    </th>
                    <th style='width:130px;'>
                      {if $_GPC['type']==1}
                        提现时间
                      {elseif $_GPC['type']==0}
                        充值时间
                      {elseif $_GPC['type']==2}
                        最近返现时间
                      {else}
                        未定义时间
                      {/if}
                    </th>

                    <!-- type specific columns -->

                    {if $_GPC['type']==0}<th style='width:120px;'>充值方式</th>{/if}


                    {if $_GPC['type']==2}<th style='width:120px;'>商品价格</th>{/if}
                    {if $_GPC['type']==2}<th style='width:120px;'>反现比例</th>{/if}

                    <!-- status and actions -->
                    <th style='width:120px;'>状态</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {loop $list $row}
                <tr>
                    <!-- general columns -->
                    <td>
                      {if $_GPC['type']==2}
                        {$row['ordersn']}
                      {else}
                        {if !empty($row['logno'])}
                          {if strlen($row['logno'])<=22}
                            {$row['logno']}
                          {else}
                            recharge{$row['id']}
                          {/if}
                        {else}
                          recharge{$row['id']}
                        {/if}
                      {/if}
                    </td>
                    <td><img src='{$row['avatar']}' style='width:30px;height:30px;padding1px;border:1px solid #ccc' /> {$row['nickname']}</td>
                    <td>{$row['realname']}<br/>{$row['mobile']}</td>
                    <td   class='hidden-xs'>{$row['weixin']}</td>
                    <td   class='hidden-xs'>{if empty($row['levelname'])}普通会员{else}{$row['levelname']}{/if}</td>
                    <td   class='hidden-xs'>{if empty($row['groupname'])}无分组{else}{$row['groupname']}{/if}</td>
                    <td>
                      {$row['refunded_price']}
                      {if $_GPC['type']==2}
                      {else}
                        {$row['money']}
                      {/if}
                    </td>
                    <td>
                      {if $row['createtime']}
                        {php echo date('Y-m-d H:i',$row['createtime'])}
                      {/if}
                    </td>

                    <!-- type specific columns -->
                    {if $_GPC['type']==0}
                    <td>
                        {if $row['rechargetype']=='alipay'}
                        <span class='label label-warning'>支付宝</span>
                        {else if $row['rechargetype']=='wechat'}
                        <span class='label label-success'>微信</span>
                         {else if $row['rechargetype']=='system'}
                         {if $row['money']>0}
                        <span class='label label-primary'>后台</span>
                        {else}
                        <span class='label label-default'>后台扣款</span>
                        {/if}

                        {/if}
                    </td>
                    {/if}

                    <!-- 商品价格 -->
                    {if $_GPC['type']==2}<td>{$row['price']}</td>{/if}
                    <!-- 返现比例 -->
                    {if $_GPC['type']==2}<td>{php echo number_format(100.0*$row['single_refund_price']*$row['num_refund'] / $row['price'],2)}%</td>{/if}

                    <!-- status and actions -->
                    <td>
                      {if $_GPC['type']==2}
                        <span class='label label-default'>已返现: {$row['num_refunded']} / {$row['num_refund']}</span>
                      {else}
                        {if $row['status']==0}
                        <span class='label label-default'>{if $row['type']==1}申请中{else}未充值{/if}</span>
                        {else if $row['status']==1}
                        <span class='label label-success'>{if $row['type']==1}成功{else}充值成功{/if}</span>
                        {else if $row['status']==-1}
                        <span class='label label-warning'>{if $row['type']==-1}失败{/if}</span>
                        {else if $row['status']==3}
                        <span class='label label-danger'>{if $row['type']==0}充值退款{/if}</span>
                        {/if}
                      {/if}
                    </td>

                    <td>
                      {if $_GPC['type']==2}
                        <a class='btn btn-danger' onclick="return confirm('确认返现{$row['single_refund_price']}?')" href="{php echo $this->createWebUrl('finance/log',array_merge(array('op'=>'pay','paytype'=>'cashback'),$row));}">返现</a>
                      {else}
                        {ifp 'member.member.view'}
                        <a class='btn btn-default' href="{php echo $this->createWebUrl('member',array('op'=>'detail','id' => $row['mid']));}">用户信息</a>
                        {/if}
                          {if $row['type']==0 && $row['status']==1}
                              {if $row['rechargetype']=='alipay' || $row['rechargetype']=='wechat'}
                                {ifp 'finance.recharge.refund'}
                                  <a class='btn btn-danger' onclick="return confirm('确认退款到微信钱包?')" href="{php echo $this->createWebUrl('finance/log',array('op'=>'pay','paytype'=>'refund','id' => $row['id']));}">退款</a>
                              {/if}
                          {/if}
                        {/if}
                        {if $row['type']==1 && $row['status']==0}
                          {ifp 'finance.withdraw.withdraw'}
                          <a class='btn btn-default' onclick="return confirm('确认微信钱包提现?')" href="{php echo $this->createWebUrl('finance/log',array('op'=>'pay','paytype'=>'wechat','id' => $row['id']));}">微信提现</a>
                          <a class='btn btn-default' onclick="return confirm('确认手动提现完成?')" href="{php echo $this->createWebUrl('finance/log',array('op'=>'pay','paytype'=>'manual','id' => $row['id']));}">手动提现</a>
                          <a class='btn btn-default' onclick="return confirm('确认拒绝提现申请?')" href="{php echo $this->createWebUrl('finance/log',array('op'=>'pay','paytype'=>'refuse','id' => $row['id']));}">拒绝</a>
                        {/if}
                        {/if}
                      {/if}
                    </td>
                </tr>
                {/loop}
            </tbody>
        </table>
           {$pager}
    </div>
</div>


<!--
<div class="col-md-8 col-xs-12" id="model_date">
  {php echo tpl_form_field_daterange('update_time', array('starttime'=>date('Y-m-d H:i', $starttime),'endtime'=>date('Y-m-d  H:i', $endtime)),true);}
</div> -->



<script>
$('#myModal').on('show.bs.modal', function (event) {
  var button = $(event.relatedTarget); // Button that triggered the modal

  var refund_id = button.data('refundid'); // Extract info from data-* attributes
  var goodssn = button.data('goodssn'); // Extract info from data-* attributes
  var period = button.data('period'); // Extract info from data-* attributes
  var single_refund_price = button.data('srp'); // Extract info from data-* attributes
  var num_refund = button.data('nf'); // Extract info from data-* attributes
  var activate = button.data('activate'); // Extract info from data-* attributes
  var start_date = button.data('startdate'); // Extract info from data-* attributes
  var end_date = button.data('enddate'); // Extract info from data-* attributes

  var modal = $(this);
  modal.find('.modal-body input[name=refund_id]').val(refund_id);
  modal.find('.modal-body input[name=update_goodssn]').val(goodssn);
  modal.find('.modal-body input[name=update_period]').val(period);
  modal.find('.modal-body input[name=update_single_refund_price]').val(single_refund_price);
  modal.find('.modal-body input[name=update_num_refund]').val(num_refund);
  modal.find('.modal-body input[name=update_activate]').val(activate);


  // get selected time. Note timezone problem not solved
  if (!start_date) {
    start_date = 0;
  }

  if (!end_date) {
    end_date = Math.round(Date.now() / 1000 + 3600 * 24 * 365);
  }

  start_date = new Date(parseInt(start_date)*1000);
  end_date = new Date(parseInt(end_date)*1000);

  var start_date_str = start_date.getFullYear() + "-" + (start_date.getMonth() + 1) + "-" + start_date.getDate() + " " + start_date.getHours() + ":" + start_date.getMinutes();
  var end_date_str = end_date.getFullYear() + "-" + (end_date.getMonth() + 1) + "-" + end_date.getDate() + " " + end_date.getHours() + ":" + end_date.getMinutes();


  modal.find('.modal-body #model_date').html('<div class="col-sm-7 col-lg-9 col-xs-12"><input name="time[start]" type="hidden" value="'+start_date_str+'"><input name="time[end]" type="hidden" value="'+end_date_str+'"><button class="btn btn-default daterange daterange-time" type="button" data-original-title="" title=""><span class="date-title">'+start_date_str+' 至 '+end_date_str+'</span> <i class="fa fa-calendar"></i></button></div>');


  require(["daterangepicker"], function($){
		$(function(){
			$(".daterange.daterange-time").each(function(){
				var elm = this;
				$(this).daterangepicker({
					startDate: $(elm).prev().prev().val(),
					endDate: $(elm).prev().val(),
					format: "YYYY-MM-DD HH:mm",
					timePicker: true,
					timePicker12Hour : false,
					timePickerIncrement: 1,
					minuteStep: 1
				}, function(start, end){
					$(elm).find(".date-title").html(start.toDateTimeStr() + " 至 " + end.toDateTimeStr());
					$(elm).prev().prev().val(start.toDateTimeStr());
					$(elm).prev().val(end.toDateTimeStr());
				});
			});
		});
	});
})
</script>

{template 'web/_footer'}
